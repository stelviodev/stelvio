# AWS S3 (Object Storage)

## S3 Buckets

Stelvio supports creating and managing S3 buckets using the `Bucket` component.

Create an S3 bucket and link it to an API Gateway handler:

```python
@app.run
def run() -> None:
    bucket = Bucket("todo-bucket")

    api = Api("todo-api")
    api.route("GET", "/write", handler="functions/write.get", links=[bucket])
    api.route("GET", "/read", handler="functions/read.get", links=[bucket])
```

Using the [linking mechanism](/guides/linking), you can easily access the S3 bucket in your Lambda functions using the regular [`boto3`](https://boto3.amazonaws.com/) library:

```python
import boto3
from stlv_resources import Resources


def get(event, context):
    s3_client = boto3.client("s3")
    bucket_name = Resources.todoBucket.bucket_name
    s3_client.put_object(Bucket=bucket_name, Key="hello.txt", Body="Hello, World!")
    return {"statusCode": 200, "body": "Hello, World!"}
```

### Public Access

By default, all public access is blocked for S3 buckets created with the `Bucket` component. 

You can change that behaviour by setting the `access` argument to `'public'`:

```python
@app.run
def run() -> None:
    bucket = Bucket("todo-bucket", access="public")
```

??? note "How access is implemented"

    Internally, access to S3 buckets is handled by the `BucketPublicAccessBlock` resource. 

    It is created with the followign parameters:

    ```python
        block_public_acls=<Value>,
        block_public_policy=<Value>,
        ignore_public_acls=<Value>,
        restrict_public_buckets=<Value>,
    ```
    
    `<Value>` is set to either `False` for public access or `True` for private access (default).
    
    | Parameter                | Description                                                                 |
    |--------------------------|-----------------------------------------------------------------------------|
    | `block_public_acls`      | Whether to block public ACLs.                                               |
    | `block_public_policy`    | Whether to block public policies.                                           |
    | `ignore_public_acls`     | Whether to ignore public ACLs.                                              |
    | `restrict_public_buckets`| Whether to restrict public buckets.                                         |
    
    Additionally, a policy for `s3:GetObject` is created to allow public read access to the objects in the bucket if `access` is set to `'public'`.
    
    See the [Pulumi Documentation](https://www.pulumi.com/registry/packages/aws/api-docs/s3/bucketpublicaccessblock/) for more information.

## Static Websites

Stelvio can create and manage S3 buckets for static website hosting using the `S3StaticWebsite` component.

Create a static website from a directory using the `S3StaticWebsite` component:

```python
@app.run
def run() -> None:
    config = mkdocs.config.load_config("mkdocs.yml")
    mkdocs.commands.build.build(config)

    _ = S3StaticWebsite(
        "s3-static-mkdocs",
        directory="site",
        custom_domain="s3-2." + CUSTOM_DOMAIN_NAME,
    )
```

- Creates an S3 bucket for static website hosting
- Creates a CloudFront distribution for the S3 bucket, so that it is compatible with 3rd party DNS providers
    - If CloudFront distribution is omitted, a DNS record will need to be created with the same name as the S3 bucket which is obviously not possible with 3rd party DNS providers
- Creates an S3 object for each file in the static website directory
- Automatically creates a DNS record for the CloudFront distribution if a DNS provider is configured
